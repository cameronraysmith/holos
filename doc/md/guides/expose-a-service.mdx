---
description: Use Holos to expose a Service with the Gateway API.
slug: /guides/expose-a-service
sidebar_position: 300
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';

# Expose a Service

In this guide, you'll learn how to expose a service with Holos using the Gateway
API.

The [Concepts](/docs/concepts) page defines capitalized terms such as Platform
and Component.

## What you'll need {#requirements}

You'll need the following tools installed to complete this guide.

1. [holos](/docs/install) - to build the Platform.
2. [helm](https://helm.sh/docs/intro/install/) - to render Helm Components.
3. [kubectl](https://kubernetes.io/docs/tasks/tools/) - to render Kustomize Components.

Optionally, if you'd like to apply the rendered manifests to a real Cluster,
first complete the [localhost Guide](../local-cluster).

## Create a Git Repository

Start by initializing an empty Git repository. Holos operates on local files
stored in a Git repository.

<Tabs groupId="init">
  <TabItem value="command" label="Command">
```bash
mkdir expose-a-service
cd expose-a-service
git init
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
Initialized empty Git repository in /expose-a-service/.git/
```
  </TabItem>
</Tabs>

This guide assumes you will run commands from the root directory of the Git
repository unless stated otherwise.

## Generate the Platform {#Generate-Platform}

Start by generating a platform with one workload Cluster.  The `guide` Platform
is intended as a starting point for all of our guides.

<Tabs groupId="generate-platform">
  <TabItem value="command" label="Command">
```bash
holos generate platform guide
holos generate component workload-cluster
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
generated component
```
  </TabItem>
</Tabs>

Commit the generated platform config to the repository.

<Tabs groupId="commit-platform">
  <TabItem value="command" label="Command">
```bash
git add .
git commit -m "holos generate platform guide - $(holos --version)"
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
[main (root-commit) 0b17b7f] holos generate platform guide - 0.93.3
  213 files changed, 72349 insertions(+)
  ...
```
  </TabItem>
</Tabs>

## Gateway API

The Gateway API is an official Kubernetes project focused on L4 and L7 routing .
You'll use the custom resources defined by the Gateway API to expose the httpbin
service outside of the cluster.  The Kubernetes Gateway API does not come
installed by default on most Kubernetes clusters, so we need to manage the
custom resource definitions (CRDs).

Run the following command to generate a Component to manage the Gateway API.

<Tabs groupId="gen-gateway-api">
  <TabItem value="command" label="Command">
```bash
holos generate component gateway-api
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
generated component
```
  </TabItem>
</Tabs>

The command generates two main configuration files, one at the leaf, and another
at the root of the tree.  At the leaf, the config produces a Kustomize build
plan for Holos to render.  At the root, the config adds the Component to all
Clusters in the Platform.

<Tabs groupId="gateway-api-files">
  <TabItem value="components/gateway-api/gateway-api.cue" label="Leaf">
    `components/gateway-api/gateway-api.cue`
```cue showLineNumbers
package holos

// Produce a kubectl kustomize build plan.
(#Kustomize & {Name: "gateway-api"}).Output
```
  </TabItem>
  <TabItem value="gateway-api.gen.cue" label="Root">
    `gateway-api.gen.cue`
```cue showLineNumbers
package holos

// Manage on every Cluster in the Platform
for Fleet in #Fleets {
	for Cluster in Fleet.clusters {
		#Platform: Components: "\(Cluster.name)/gateway-api": {
			path:    "components/gateway-api"
			cluster: Cluster.name
		}
	}
}
```
  </TabItem>
</Tabs>

Notice the Component also includes a `kustomization.yaml` file at the leaf.
This is an unmodified upstream copy of the standard way to install the Gateway
API.

<Tabs groupId="gateway-kustomization-yaml">
  <TabItem value="kustomization.yaml" label="kustomization.yaml">
  `components/gateway-api/kustomization.yaml`
```yaml showLineNumbers
resources:
- standard/gateway.networking.k8s.io_gatewayclasses.yaml
- standard/gateway.networking.k8s.io_gateways.yaml
- standard/gateway.networking.k8s.io_grpcroutes.yaml
- standard/gateway.networking.k8s.io_httproutes.yaml
- standard/gateway.networking.k8s.io_referencegrants.yaml
```
  </TabItem>
</Tabs>

Render the Platform to render the Component for the workload clusters.

<Tabs groupId="render-platform-gateway">
  <TabItem value="command" label="Command">
```bash
holos render platform ./platform
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
rendered components/gateway-api for cluster workload in 279.312292ms
```
  </TabItem>
</Tabs>

:::tip
This example is equivalent to running `kubectl kustomize
./components/gateway-api` and saving the output to a file.  Holos simplifies
this task and makes it consistent with Helm and other tools.
:::

Add and commit the Component and rendered Platform.

<Tabs groupId="commit-gateway-api">
  <TabItem value="command" label="Command">
```bash
git add .
git commit -m "add gateway-api component"
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
[main 88575a5] add gateway-api component
 9 files changed, 26907 insertions(+)
 create mode 100644 components/gateway-api/gateway-api.cue
 create mode 100644 components/gateway-api/kustomization.yaml
 create mode 100644 components/gateway-api/standard/gateway.networking.k8s.io_gatewayclasses.yaml
 create mode 100644 components/gateway-api/standard/gateway.networking.k8s.io_gateways.yaml
 create mode 100644 components/gateway-api/standard/gateway.networking.k8s.io_grpcroutes.yaml
 create mode 100644 components/gateway-api/standard/gateway.networking.k8s.io_httproutes.yaml
 create mode 100644 components/gateway-api/standard/gateway.networking.k8s.io_referencegrants.yaml
 create mode 100644 deploy/clusters/workload/components/gateway-api/gateway-api.gen.yaml
 create mode 100644 gateway-api.gen.cue
```
  </TabItem>
</Tabs>

Optionally apply the rendered component to your cluster.

<Tabs groupId="apply-gateway-api">
  <TabItem value="command" label="Command">
```bash
kubectl apply --server-side=true -f deploy/clusters/workload/components/gateway-api
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
customresourcedefinition.apiextensions.k8s.io/gatewayclasses.gateway.networking.k8s.io serverside-applied
customresourcedefinition.apiextensions.k8s.io/gateways.gateway.networking.k8s.io serverside-applied
customresourcedefinition.apiextensions.k8s.io/grpcroutes.gateway.networking.k8s.io serverside-applied
customresourcedefinition.apiextensions.k8s.io/httproutes.gateway.networking.k8s.io serverside-applied
customresourcedefinition.apiextensions.k8s.io/referencegrants.gateway.networking.k8s.io serverside-applied
```
  </TabItem>
</Tabs>

## Namespaces

Platform operators often need to manage Namespaces prior to services being
deployed.  This is necessary because a Namespace is a security boundary.
Platform operators often need to manage service accounts, roles, and secrets
before workloads can be deployed.

Holos makes this task easier, safer, and more consistent through the namespaces
component.  The namespaces component offers a mechanism for other components to
register the Namespace they need.  The namespaces component initializes each
Namespace and optionally mixes in resources consistently across the Platform.

Run the following command to generate a Component to manage Namespaces across
the Platform.

<Tabs groupId="gen-namespaces">
  <TabItem value="command" label="Command">
```bash
holos generate component namespaces
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
generated component
```
  </TabItem>
</Tabs>

The command generates two main configuration files once again, one at the leaf,
and another at the root.  The leaf uses a Kubernetes build plan to produce
resources directly from CUE.

<Tabs groupId="namespaces-files">
  <TabItem value="components/namespaces/namespaces.cue" label="Leaf">
    `components/namespaces/namespaces.cue`
```cue showLineNumbers
package holos

let Objects = {
	Name: "namespaces"
	// highlight-next-line
	Resources: Namespace: #Namespaces
}

// Produce a kubernetes objects build plan.
(#Kubernetes & Objects).Output
```
  </TabItem>
  <TabItem value="namespaces.gen.cue" label="Root">
    `namespaces.gen.cue`
```cue showLineNumbers
package holos

import corev1 "k8s.io/api/core/v1"

// #Namespaces defines all managed namespaces in the Platform.
// Holos adopts the sig-multicluster position of namespace sameness.
#Namespaces: {
	// Validate against v1 of the kubernetes core api
	// highlight-next-line
	[Name=string]: corev1.#Namespace & {
		metadata: name: Name
	}
}

// Manage the Component on every Cluster in the Platform
for Fleet in #Fleets {
	for Cluster in Fleet.clusters {
		#Platform: Components: "\(Cluster.name)/namespaces": {
			path:    "components/namespaces"
			cluster: Cluster.name
		}
	}
}
```
  </TabItem>
</Tabs>

Notice how resources are managed directly in CUE at the leaf with the Kubernetes
Component.  This is the same mechanism used to mix-in resources to Helm and
Kustomize Components.  The leaf refers to `#Namespaces` defined at the root.  At
the root `#Namespaces` enforces a constraint: each Namespace must conform to the
`k8s.io/api/core/v1` specification.

:::important
We've covered three kinds of Components so far: Helm in the [Quickstart],
Kustomize and Kubernetes in this guide.  Holos offers a consistent way to manage
these different packaging methods safely and easily.

- At the **leaf** Holos tailors the Component to your Platform, mixing
in resources and customizing the rendered output.
- At the **root** Holos integrates a Component with the rest of your Platform.

You'll see this pattern again and again as you build your Platform.
:::

Render the Platform to render the Component for the workload clusters.

<Tabs groupId="render-platform-gateway">
  <TabItem value="command" label="Command">
```bash
holos render platform ./platform
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
rendered components/namespaces for cluster workload in 72.675292ms
rendered components/gateway-api for cluster workload in 259.174583ms
```
  </TabItem>
</Tabs>

Add and commit the Component and rendered Platform.

<Tabs groupId="commit-gateway-api">
  <TabItem value="command" label="Command">
```bash
git add .
git commit -m "add namespaces component"
```
  </TabItem>
  <TabItem value="output" label="Output">
```txt showLineNumbers
[main 1bf0d61] add namespaces component
 3 files changed, 30 insertions(+)
 create mode 100644 components/namespaces/namespaces.cue
 create mode 100644 deploy/clusters/workload/components/namespaces/namespaces.gen.yaml
 create mode 100644 namespaces.gen.cue
```
  </TabItem>
</Tabs>

`#Namespaces` is currently empty, so the rendered output of
`namespaces.gen.yaml` is also empty.  Namespaces will be automatically managed
as you add Components to the Platform.

## Istio

## httpbin

[Quickstart]: /docs/quickstart
